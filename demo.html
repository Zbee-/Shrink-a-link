<!DOCTYPE html>
<html>
  <head>
		<title>Shrink-a-Link</title>
		<link href="style.css" rel="stylesheet" type="text/css">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	</head>
	<body>
	
<?php
   	require "config.php";
        $error = "";
        $good = true;
        $sgood = true;

//Non-existant links
        if (isset($_GET['exist'])) {
            $exist = $_GET['exist'];
        } else {
            $exist = "yes";
        }

        if (isset($_GET['attempt'])) {
            $attempt = $_GET['attempt'];
        } else {
            $attempt = "";
        }

        if ($exist == "no" && $attempt != "") {
            $deleted = yes;
            $error .= '<div class="ribbon">Sorry, '.$root_url.'/'.$attempt.' does not exist.</div><br>';
        }

        if ($exist == "no" && $deleted != yes) {
            $error .= '<div class="ribbon">Sorry, the shrunken url you tried to visit does not exist.</div><br>';
        }

        if ($exist = "no") {
            mysql_query("DELETE FROM links WHERE shrink='".$attempt."' LIMIT 1");
        }

//Functions
	function sanitize($sql, $formUse = true) {
		$sql = preg_replace("/(from|script|src|select|insert|delete|where|drop table|show tables|,|'|\*|--|\\\\)/i","",$sql);
		$sql = trim($sql);
		$sql = strip_tags($sql);
		if(!$formUse || !get_magic_quotes_gpc()) {
			$sql = addslashes($sql);
		}
		return $sql;
	}

//Shrink
        if (isset($_POST['url'])) {
            $shrink = substr(str_shuffle(str_repeat($char_string, 10)), 0, $length);

            if (strlen($shrunk) !== 5) {
                $shrink = substr(str_shuffle(str_repeat($char_string, 11)), 0, $length);
            }

            $url = sanitize($_POST['url']);
            if (empty($url)) {
                $error .= '<div class="ribbon">You have nothing in the url box.</div><br/>';
                $good = false;
            }

//Real URL checking
	if (strstr($url, "http://") == $url) {
		$url = $url;
	} elseif (strstr($url, "https://") == $url) {
		$url = $url;
	} else {
		$url = "http://www.".$url."";
	}
		
//If given url matches a url already in the table, simply return that url's shrink code
            $match_query = mysql_query("SELECT * FROM links WHERE link='".$_POST['url']."'");
            $numrows = mysql_num_rows($match_query);
            if ($numrows == 1) {
                while ($value = mysql_fetch_array($match_query)) {
                    $good = false;
                    $error .= ''.$numrows.'';
                    $shrink = $value['shrink'];
                    $error .= '<div class="ribbon">Link shrunk successfully! <a href="'.$root_url.'/'.$value['shrink'].'">'.$root_url.''.$value['shrink'].'</a></div><br>';
                }
            }

            $s_match_query = mysql_query("SELECT * FROM links WHERE shrink='".$shrink."'");
            $s_numrows = mysql_num_rows($s_match_query);
            if ($s_numrows == 1) {
                while ($value = mysql_fetch_array($s_match_query)) {
                    $good = false;
                    $shrink = substr(str_shuffle(str_repeat($char_string, 12)), 0, $length);
                    $error .= '<div class="ribbon">Link shrunk successfully! <a href="'.$root_url.'/'.$value['shrink'].'">'.$root_url.''.$value['shrink'].'</a></div><br>';
                }
            }

            if ($good == true) {
                $query = mysql_query("INSERT INTO links (link, shrink) VALUES ('$url','$shrink')");
                if (!$query) {
                    $error .= '<div class="ribbon">MySQL Error: ' . mysql_error() . '</div><br>';
                } else {
                    $error .= '<div class="ribbon">Link shrunk successfully! <a href="'.$root_url.'/'.$shrink.'">'.$root_url.''.$shrink.'</a></div><br>';
                }
            }
        }
?>
	
		<div id="header"><a href="http://zbee.me">Zbee's</a> Shrink-a-Link</div>
		
		<div id="ribbon-container">
				<div class="ribbon git"><a href="http://zbee.me/z_WRW">On Github!</a></div>
				<?php echo $error; ?>
		</div>

		<form action="index.php" method="post" id="main">
				<em>Insert a link to have it shrunk</em><br>
				<input type="text" name="url" <?php if ($sgood !== true) { echo 'class="fail" placeholder="url to shrink"'; } else { echo 'placeholder="url to shrink"'; } ?>>
				<br>
				<input class="punch" type="submit" value="Shrink!">
		</form>

	
		<div id="footer">Shrink-a-link made by <a href="http://zbee.me">Zbee</a> 2013, all rights reserved.</div>
		
	</body>
</html>
